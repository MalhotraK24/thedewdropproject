<!DOCTYPE html>
<html lang="en">
    <head>
        {% block head %} {% endblock %}
    </head>
    <body>
        <div id="snackbar">A new version of this app is available. Click <a id="reload">here</a> to update.</div>
        {% block content %} {% endblock %}
        {% include "./partials/_footer.njk" %}
        {% include "./partials/_scroll-to-top.njk" %}
    </body>
    <!-- Registering a service worker -->
    <script>
        let newWorker;

        function showUpdateBar() {
            let snackbar = document.getElementById('snackbar');
            snackbar.className = 'show';
        }

        // The click event on the pop up notification
        document.getElementById('reload').addEventListener('click', function(){
            newWorker.postMessage({ action: 'skipWaiting' });
        });

        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.register('/serviceworker.js').then(reg => {
                reg.addEventListener('updatefound', () => {
                    console.log("Update Found!");
                    // A wild service worker has appeared in reg.installing!
                    newWorker = reg.installing;

                    newWorker.addEventListener('statechange', () => {
                        console.log("State Changed!");
                        // Has network.state changed?
                        switch (newWorker.state) {
                            case 'installed':
                            console.log("New Service Worker state is installed!");
                            if (navigator.serviceWorker.controller) {
                                // new update available
                                showUpdateBar();
                            }
                            // No update available
                            break;
                        }
                    });
                });
            });

            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', function () {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }

        </script>
</html>